<?php
// database.php - функции для работы с базой данных
require_once 'config.php';

/**
 * Подключение к базе данных
 */
function getDBConnection() {
    static $connection = null;
    
    if ($connection === null) {
        try {
            $connection = new mysqli(DB_HOST, DB_USER, DB_PASS, DB_NAME);
            
            if ($connection->connect_error) {
                throw new Exception("Ошибка подключения: " . $connection->connect_error);
            }
            
            $connection->set_charset("utf8");
        } catch (Exception $e) {
            die("Ошибка базы данных: " . $e->getMessage());
        }
    }
    
    return $connection;
}

/**
 * Получить все новости, отсортированные по дате (новые сверху)
 */
function getAllNews() {
    $db = getDBConnection();
    
    $query = "SELECT * FROM news ORDER BY date DESC";
    $result = $db->query($query);
    
    if (!$result) {
        die("Ошибка запроса: " . $db->error);
    }
    
    $news = [];
    while ($row = $result->fetch_assoc()) {
        $news[] = $row;
    }
    
    return $news;
}

/**
 * Получить одну новость по ID
 */
function getNewsById($id) {
    $db = getDBConnection();
    
    $id = (int)$id;
    $query = "SELECT * FROM news WHERE id = ?";
    
    $stmt = $db->prepare($query);
    $stmt->bind_param("i", $id);
    $stmt->execute();
    
    $result = $stmt->get_result();
    $news = $result->fetch_assoc();
    
    $stmt->close();
    
    return $news;
}

/**
 * Инициализация базы данных (создание таблицы если её нет)
 */
function initDatabase() {
    $db = getDBConnection();
    
    // Проверяем существование таблицы
    $result = $db->query("SHOW TABLES LIKE 'news'");
    
    if ($result->num_rows == 0) {
        // Создаем таблицу
        $sql = "CREATE TABLE news (
            id INT(11) UNSIGNED AUTO_INCREMENT PRIMARY KEY,
            date DATETIME DEFAULT NULL,
            title VARCHAR(250) NOT NULL DEFAULT '',
            announce TEXT DEFAULT NULL,
            content TEXT DEFAULT NULL,
            image VARCHAR(250) NOT NULL DEFAULT ''
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8";
        
        $db->query($sql);
        
        // Добавляем тестовые данные
        addSampleNews();
    }
}

/**
 * Добавить тестовые новости
 */
function addSampleNews() {
    $db = getDBConnection();
    
    $news = [
        [
            'date' => '2412-06-11 00:00:00',
            'title' => 'Возвращение этнографа',
            'announce' => '<p>Сегодня с Проксимы вернулась этнографическая экспедиция Джона Голдрама.</p>',
            'content' => '<p>Сегодня с Проксимы вернулась этнографическая экспедиция под управлением профессора Джона Голдрама из Майхартского университета. Экспедиция работала в джунглях Туманного континента и занималась изучением неконтактного племени двухвостых зюзюмов.</p><p>"Это племя называет себя Ракатука-Тум-Тум и крайне неохотно контактирует с пришельцами", - сказал Джон Голдрам. На вопрос о том, каковы они - неконтактные зюзюмы, профессор заявил, что неконтактные зюзюмы такие же двухвостые и скандальные как и контактные, только неконтактные.</p><p>Ждем от профессора Голдрама новых интересных подробностей!</p>',
            'image' => 'c6e252ce94fd757ae97522197c394239.jpg'
        ],
        [
            'date' => '2412-06-08 00:00:00',
            'title' => 'Несчастный случай с известной светской дивой',
            'announce' => '<p>Светская дива Алиса Уткина попала под троллейбус, пытаясь уйти от преследования.</p>',
            'content' => '<p>Находясь в парке развлечений "XX век", известная светская дива Алиса Уткина в неположенном месте пересекала маршрут т.н. троллейбуса (реконструкция древнего электрического дилижанса) и попала под его колеса. В бессознательном состоянии она была доставлена в больницу и сейчас находится в коме.</p><p>Свидетели утверждают, что в парк развлечений она попала, спасаясь от преследования двух мужчин в униформе сотрудников космопорта. Те сразу же были задержаны полицией и опрошены. Оказалось, что они действительно работают в космопорту грузчиками, а Алису преследовали, поскольку она похитила с багажной ленты миелофон - антикварный музыкальный инструмент работы самого Страдивари.</p><p>Это очень шокирующая информация! Как могла так поступить Алиса? Она довольно обеспеченная особа и является владелицей элитных ночных клубов "Поле чудес", "Кроличья нора" и "Зазеркалье". Но злые языки, тем не менее, утверждают, что Алиса не гнушалась обществом известного мошенника Базилио и вполне могла участвовать в его преступных схемах.</p><p>Хозяин похищенного миелофона - известный виртуоз Ионак Тебенерас - был крайне опечален произошедшим и даже позволил себе некуртуазные высказывания в адрес как Алисы Уткиной, так и сотрудников космопорта.</p>',
            'image' => '6322ebc804af3746c221c43fbf30354f.jpg'
        ],
        [
            'date' => '2412-05-26 00:00:00',
            'title' => 'Папа Римский совершил визит в систему Альфы Центавра',
            'announce' => '<p>Папа Римский Жан-Клод XIV посетил с апостольским визитом систему Альфы Центавра. Он принял участие в ряде благотворительных мероприятий и совершил богослужение в соборе Ван-Дамм-де-Ури.</p>',
            'content' => '<p>Папа Римский Жан-Клод XIV посетил с апостольским визитом систему Альфы Центавра по приглашению Президента системы Ячсми Тьбю. Прямую трансляцию из межзвездного космопорта вел местный телеканал Azz-1. Понтифика встретил министр иностранных дел Альфы Центавра, проведший с ним затем короткую встречу.</p><p>Понтифик принял участие в ряде благотворительных мероприятий и совершил богослужение в соборе Ван-Дамм-де-Ури. В конце визита он посетил Проксиму, где провел встречу с архиепископом Мельдонием и прочитал двухвостым зюзюмам проповедь о вреде физкультуры.</p>',
            'image' => 'd54b2b97477b209ec277887126a35100.jpg'
        ],
        [
            'date' => '2412-05-20 00:00:00',
            'title' => 'На чемпионате по пустотной гребле победила команда с Фобоса',
            'announce' => '<p>В поясе астероидов на проходившем в последние выходные этапе системного чемпионата по пустотной гребле команда с Фобоса одержала убедительную победу.</p>',
            'content' => '<p>В поясе астероидов на проходившем в последние выходные этапе системного чемпионата по пустотной гребле команда геномодифицированных пумперов с Фобоса одержала убедительную победу, опередив ближайшего соперника (команду двухвостых зюзюмов с Проксимы) на две десятых сола. Тем самым команда обеспечила себе выход в групповую часть чемпионата.</p><p>Третье место на данном этапе не присуждалось по причине отсутствия третьего участника.</p><p>Занявшие вторую позицию зюзюмы подали протест в Спортлото за дискриминацию. Адвокат проксимской команды заявил, что пумперы одержали победу умышленно, со всей злонамеренностью стараясь, чтобы зюзюмы оказались на втором месте. Отметим, что выходцы с Проксимы участвуют в чемпионате без отборочных соревнований, попав туда по квоте Комитета по квотам.</p>',
            'image' => 'db3c84cc08059b60d742069c1df561dc.jpg'
        ]
    ];
    
    foreach ($news as $item) {
        $stmt = $db->prepare("INSERT INTO news (date, title, announce, content, image) VALUES (?, ?, ?, ?, ?)");
        $stmt->bind_param("sssss", 
            $item['date'],
            $item['title'],
            $item['announce'],
            $item['content'],
            $item['image']
        );
        $stmt->execute();
        $stmt->close();
    }
}
?>